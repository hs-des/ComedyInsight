version: "3.9"

x-healthcheck-defaults: &health_defaults
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 10s

services:
  postgres:
    image: postgres:15
    container_name: comedyinsight-postgres
    restart: unless-stopped
    profiles: ["dev", "prod"]
    env_file: .env
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: comedyinsight
    ports:
      - "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/healthchecks:/opt/healthchecks:ro
    healthcheck:
      test: ["CMD", "/bin/sh", "/opt/healthchecks/postgres-healthcheck.sh"]
      <<: *health_defaults
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.25"
          memory: 256M

  redis:
    image: redis:7-alpine
    container_name: comedyinsight-redis
    restart: unless-stopped
    profiles: ["dev", "prod"]
    env_file: .env
    command: >
      sh -c 'if [ -n "redis123" ]; then
        redis-server --save 60 1 --loglevel warning --requirepass "redis123";
      else
        redis-server --save 60 1 --loglevel warning;
      fi'
    ports:
      - "6379"
    volumes:
      - redis_data:/data
      - ./scripts/healthchecks:/opt/healthchecks:ro
    healthcheck:
      test: ["CMD", "/bin/sh", "/opt/healthchecks/redis-healthcheck.sh"]
      <<: *health_defaults
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M

  minio:
    image: minio/minio:latest
    container_name: comedyinsight-minio
    restart: unless-stopped
    profiles: ["dev", "prod"]
    command: server /data --console-address ":9001"
    env_file: .env
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
      - ./scripts/healthchecks:/opt/healthchecks:ro
    healthcheck:
      test: ["CMD", "/bin/sh", "/opt/healthchecks/minio-healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.25"
          memory: 256M

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: comedyinsight-api
    restart: unless-stopped
    profiles: ["dev", "prod"]
    env_file: .env
    environment:
      PORT: ${API_PORT:-3000}
      NODE_ENV: ${NODE_ENV:-development}
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/comedyinsight
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: comedyinsight
      DB_USER: postgres
      DB_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      AWS_S3_ENDPOINT: http://minio:9000
      AWS_S3_REGION: us-east-1
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_S3_BUCKET: comedyinsight-videos
      AWS_S3_USE_PATH_STYLE: "true"
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin123
      JWT_SECRET: adminjwt
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      ML_SERVICE_URL: http://ml-service:8000
    ports:
      - "${API_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      ml-service:
        condition: service_healthy
    volumes:
      - api_uploads:/app/uploads
      - ./scripts:/opt/docker-tools:ro
      - ./scripts/healthchecks:/opt/healthchecks:ro
    entrypoint: ["/bin/sh", "/opt/docker-tools/wait-for-deps.sh", "postgres:5432", "redis:6379", "minio:9000", "ml-service:8000", "--", "npm start"]
    healthcheck:
      test: ["CMD", "/bin/sh", "/opt/healthchecks/api-healthcheck.sh"]
      <<: *health_defaults
    networks:
      - backend
      - frontend
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2g
        reservations:
          cpus: "0.5"
          memory: 512M

  dashboard:
    build:
      context: ./admin-dashboard
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://api:3000}
    container_name: comedyinsight-dashboard
    restart: unless-stopped
    profiles: ["dev"]
    env_file: .env
    environment:
      DASHBOARD_PORT: ${DASHBOARD_PORT:-4173}
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:3000}
    ports:
      - "${DASHBOARD_PORT:-4173}:4173"
    depends_on:
      api:
        condition: service_healthy
    volumes:
      - ./scripts/healthchecks:/opt/healthchecks:ro
    healthcheck:
      test: ["CMD", "/bin/sh", "/opt/healthchecks/dashboard-healthcheck.sh"]
      <<: *health_defaults
    networks:
      - frontend
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  ml-service:
    build:
      context: ./ml-service
    container_name: comedyinsight-ml
    restart: unless-stopped
    profiles: ["dev", "prod"]
    env_file: .env
    environment:
      ML_SERVICE_PORT: ${ML_SERVICE_PORT:-8000}
    expose:
      - "8000"
    ports:
      - "${ML_SERVICE_PORT:-8000}:8000"
    volumes:
      - ./scripts/healthchecks:/opt/healthchecks:ro
    healthcheck:
      test: ["CMD", "/bin/sh", "/opt/healthchecks/ml-healthcheck.sh"]
      <<: *health_defaults
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.25"
          memory: 256M

  pgadmin:
    image: dpage/pgadmin4
    container_name: comedyinsight-pgadmin
    restart: unless-stopped
    profiles: ["dev"]
    env_file: .env
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@local.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    ports:
      - "8080:80"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
      - frontend

networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
  api_uploads: